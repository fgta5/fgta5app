/*! user
*
* Agung Nugroho DW
* https://github.com/agungdhewe
*
* build at 2025-08-15
*/
import e,{loadTemplate as t}from"../module.mjs";const a=new $fgta5.Application("mainapp");var n={Source:"USER",app:a,Crsl:new $fgta5.SectionCarousell(a.Nodes.Main),Sections:{userheaderList:"userHeaderList-section",userheaderEdit:"userHeaderEdit-section"}};async function o(e,a){t(e,"dlg-newdata"),n.dlgNewData=new $fgta5.Dialog("dlg-newdata",{title:"New User"}),n.dlgNewData.addAsyncEventListener("showing",async e=>{!async function(){document.getElementById("dlg-newdata-txt_email").value="asdf"}()}),n.dlgNewData.addAsyncEventListener("ok",async e=>{await async function(e,t){var a=document.getElementById("dlg-newdata-txt_email");t.result={user_email:a.value}}(0,e)})}async function s(e,t){const a=t.detail.sender,n=t.detail.dialog,o=new $fgta5.Dataloader;var s=null!=t.detail.searchtext?t.detail.searchtext:"",r={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchtext:s,offset:t.detail.offset,limit:t.detail.limit,test_delay:50,test_stop_at:35})};a.wait(),a.abortHandler=()=>{o.abort()};try{var i=await o.load("/group/header-list",r);if(0!=i.code)throw new Error(i.message);for(var d of i.result.data)t.detail.addRow(d.group_id,d.group_name,d);n.setNext(i.result.nextoffset,i.result.limit)}catch(e){$fgta5.MessageBox.error(e.message)}finally{a.wait(!1)}}var r=Object.freeze({__proto__:null,cbo_group_id_selecting:s,init:o,initSearchParams:function(e,t){const a=t.searchgroup;a.addEventListener("selecting",t=>{s(e,t)}),a.addEventListener("change",t=>{!async function(e){var t=e.Modules.userHeaderList;t.loadData(e)}(e)})},newData:async function(e){}});const i=n.Crsl,d=n.Sections.userheaderList,c=i.Items[d],l={},u=new $fgta5.Gridview("userHeaderList-tbl"),f=document.getElementById("userHeaderList-pnl_search"),w=new $fgta5.ActionButton("userHeaderList-btn_gridload"),g=c,y={};async function h(t,a){u.addEventListener("nextdata",async e=>{!async function(e,t){const a=t.detail.criteria,n=t.detail.limit,o=t.detail.nextoffset,s=t.detail.sort;await v(e,{criteria:a,limit:n,offset:o,sort:s}),u.scrollToFooter()}(t,e)}),u.addEventListener("sorting",async e=>{!async function(e,t){u.clear();const a=t.detail.sort,n=t.detail.Criteria;v(e,{criteria:n,sort:a})}(t,e)}),u.addEventListener("cellclick",async a=>{!async function(t,a){e.isMobileDevice()&&await b(t,a)}(t,a)}),u.addEventListener("celldblclick",async e=>{b(t,e)}),w.addEventListener("click",async e=>{!async function(e){m(e,null),p()}(t)});try{const e=document.querySelector('template[name="custom-search-panel"]');if(null!=e){const t=e.content.cloneNode(!0);f.prepend(t)}const a=f.querySelectorAll("[fgta5-component][binding");for(var n of a){var o=n.getAttribute("id"),s=n.getAttribute("fgta5-component"),r=n.getAttribute("binding");y[r]=new $fgta5[s](o)}const i=t.Modules.userExtender.initSearchParams;"function"==typeof i&&i(t,y)}catch(e){throw e}finally{!0===a.autoLoadGridData&&p()}}async function p(e){await u.clear(),v()}function m(e,t){l.SelectedRow=t}async function E(e,t){const a=t.getAttribute("keyvalue"),n=t.getAttribute("key"),o=e.Modules.userHeaderEdit;try{m(0,t),l.SelectedRow.keyValue=a,l.SelectedRow.key=n,await o.openSelectedData(e,{key:n,keyvalue:a})}catch(e){console.error(e),await $fgta5.MessageBox.error(e.message),m(0,null),c.show()}}async function b(e,t){const a=t.detail.tr;e.Modules.userHeaderEdit.Section.show(),await E(e,a)}async function v(e,t={}){const{criteria:a={},limit:n=0,offset:o=0,sort:s={}}=t;for(var r in y){if(!y[r].validate())return console.error("ada yang belum diisi"),!1;a[r]=y[r].value}void 0===s&&(s=u.getSort());const i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({columns:[],criteria:a,offset:o,limit:n,sort:s})};let d=$fgta5.Modal.createMask(),c=new $fgta5.Dataloader;try{const e=await c.load("/user/header-list",i),t=e.code,a=e.message,n=e.result;if(0!=t){const e=new Error("Server Error: "+a);throw e.code=t,e}void 0===o&&u.clear(),u.addRows(n.data),u.setNext(n.nextoffset,n.limit)}catch(e){console.error(e),$fgta5.MessageBox.error(e.message)}finally{d.close(),c.dispose(),c=null,d=null}}var S=Object.freeze({__proto__:null,SearchParams:y,Section:g,addNewRow:function(e,t){m(0,u.addRow(t))},getCurrentRow:function(e){return l.SelectedRow},init:h,loadData:p,removeCurrentRow:function(e){l.SelectedRow.remove()},render:async function(e){},selectNextRow:function(e){const t=l.SelectedRow;t.nextElementSibling&&E(e,t.nextElementSibling)},selectPreviousRow:function(e){const t=l.SelectedRow;t.previousElementSibling&&E(e,t.previousElementSibling)},updateCurrentRow:function(e,t){const a=l.SelectedRow;try{u.updateRow(a,t)}catch(e){throw e}}});const _={},L=n.Crsl,k=n.Sections.userheaderEdit,x=L.Items[k],C=n.Source,M="View User",$="Edit User",N="Edit",D="Lock",R=new $fgta5.ActionButton("userHeaderEdit-btn_edit"),B=new $fgta5.ActionButton("userHeaderEdit-btn_save"),H=new $fgta5.ActionButton("userHeaderEdit-btn_new","userHeader-new"),T=new $fgta5.ActionButton("userHeaderEdit-btn_delete"),A=new $fgta5.ActionButton("userHeaderEdit-btn_reset"),I=new $fgta5.ActionButton("userHeaderEdit-btn_prev"),O=new $fgta5.ActionButton("userHeaderEdit-btn_next"),j=new $fgta5.Form("userHeaderEdit-frm"),P=j.Inputs.cbo_group_id,F=x;async function J(t,a){x.addEventListener($fgta5.Section.EVT_BACKBUTTONCLICK,async t=>{!async function(t,a){let n=!1;if(j.isChanged()){"ok"==await $fgta5.MessageBox.confirm(e.BACK_CONFIRM)&&(j.reset(),n=!0)}else n=!0;n&&(j.lock(),a.detail.fn_ShowNextSection())}(0,t)}),j.addEventListener("locked",e=>{!async function(){x.Title=M,R.setText(N),R.disabled=!1,B.disabled=!0,H.disabled=!1,T.disabled=!0,A.disabled=!0,I.disabled=!1,O.disabled=!1}()}),j.addEventListener("unlocked",e=>{!async function(){x.Title=$,R.setText(D),R.disabled=!1,B.disabled=!1,H.disabled=!0,T.disabled=!1,A.disabled=!1,I.disabled=!0,O.disabled=!0}()}),j.render(),R.addEventListener("click",t=>{!async function(){if(j.isLocked())j.lock(!1);else{if(j.isChanged()||j.isNew())return void await $fgta5.MessageBox.warning(e.EDIT_WARNING);j.lock(!0)}}()}),B.addEventListener("click",e=>{!async function(e){if(!j.validate()){const e=j.getLastError();return void $fgta5.MessageBox.warning(e)}let t;const a=j.isNew();if(a)t=j.getData();else{if(!j.isChanged())return;t=j.getDataChanged()}try{let n;n=a?await async function(e,t){const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:C,data:t})};let n=new $fgta5.Dataloader;try{const e=await n.load("/user/header-create",a);if(0!=e.code)throw new Error(e.message);return e.result}catch(e){throw e}}(0,t):await async function(e,t){const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:C,data:t})};let n=new $fgta5.Dataloader;try{const e=await n.load("/user/header-update",a);if(0!=e.code)throw new Error(e.message);return e.result}catch(e){throw e}}(0,t);const o=_.obj_pk,s=n[_.key],r=await G(e,s);j.AutoID?o.value=s:V(e,{disabled:!0}),j.setData(r),j.acceptChanges(),a?(R.disabled=!1,e.Modules.userHeaderList.addNewRow(e,r)):e.Modules.userHeaderList.updateCurrentRow(e,r)}catch(e){console.error(e),await $fgta5.MessageBox.error(e.message)}}(t)}),H.addEventListener("click",a=>{!async function(t,a){const n=a.target.getAttribute("data-sectionsource"),o=t.Modules.userHeaderList,s=o.Section.Id,r=n===s;if(r)await x.show();else{let t=!1;if(j.isChanged()){"cancel"==await $fgta5.MessageBox.confirm(e.NEWDATA_CONFIRM)&&(t=!0)}if(t)return}j.AutoID?V(t,{disabled:!0,placeholder:"[AutoID]"}):V(t,{disabled:!1,placeholder:"ID"});try{let e={};const a=t.Modules.userExtender.newData;"function"==typeof a&&(e=await a(t)),await U(t,e),j.lock(!1),R.disabled=!0,T.disabled=!0}catch(e){console.error(e),await $fgta5.MessageBox.error(e.message),r&&t.Modules.userHeaderList.Section.show()}}(t,a)}),T.addEventListener("click",a=>{!async function(t){if(j.isNew())return;const a=_.obj_pk.value;if("ok"!=await $fgta5.MessageBox.confirm(e.DELETE_CONFIRM+`id: ${a}`))return;try{await async function(e,t){const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:C,id:t})};let n=new $fgta5.Dataloader;try{const e=await n.load("/user/header-delete",a);if(0!=e.code)throw new Error(e.message);return e.result}catch(e){throw e}finally{n.dispose(),n=null}}(0,a);t.Modules.userHeaderList.removeCurrentRow(t),t.Modules.userHeaderList.Section.show(),j.lock()}catch(e){console.error(e),await $fgta5.MessageBox.error(e.message)}}(t)}),A.addEventListener("click",t=>{!async function(){if(j.isNew())U();else if(j.isChanged()){if("ok"!=await $fgta5.MessageBox.confirm(e.RESET_CONFIRM))return;j.reset()}}()}),I.addEventListener("click",e=>{!async function(e){e.Modules.userHeaderList.selectPreviousRow(e)}(t)}),O.addEventListener("click",e=>{!async function(e){e.Modules.userHeaderList.selectNextRow(e)}(t)}),_.obj_pk=j.getPrimaryInput(),_.key=_.obj_pk.getBindingData(),P.addEventListener("selecting",e=>{s(0,e)})}async function U(e,t){try{j.newData(t),j.acceptChanges(),j.setAsNewData()}catch(e){throw e}}async function G(e,t){_.currentOpenedId=t;const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t})};let n=new $fgta5.Dataloader;try{const e=await n.load("/user/header-open",a);if(0!=e.code)throw new Error(e.message);return e.result}catch(e){throw _.currentOpenedId=null,e}finally{n.dispose(),n=null}}async function V(e,t){const a=_.obj_pk;a.disabled=!0===t.disabled,void 0!==t.placeholder&&(a.placeholder=t.placeholder),void 0!==t.value&&(a.value=t.value)}var z=Object.freeze({__proto__:null,Section:F,init:J,openSelectedData:async function(e,t){let a=$fgta5.Modal.createMask();try{const a=t.keyvalue,n=await G(e,a);V(e,{disabled:!0}),j.setData(n),j.acceptChanges(),j.lock()}catch(e){throw e}finally{a.close(),a=null}},render:async function(e){}});const K=n.app,W=n.Crsl;class q extends e{constructor(){super()}async main(e={}){K.setTitle("User"),K.showFooter(!0),e.autoLoadGridData=!0;const t=this;t.Modules={userHeaderList:S,userHeaderEdit:z,userExtender:r};try{await Promise.all([h(t,e),J(t),o(t)]),await async function(e){try{const t=document.getElementsByClassName("footer-buttons-container");e.renderFooterButtons(t),W.addEventListener($fgta5.SectionCarousell.EVT_SECTIONSHOWING,e=>{var a=e.detail.commingSection.Id;for(let e of t){e.getAttribute("data-section")==a?setTimeout(()=>{e.classList.remove("hidden"),e.style.animation="dropped 0.3s forwards",setTimeout(()=>{e.style.animation="unset"},300)},500):e.classList.add("hidden")}});const a=e.Modules.userExtender.extendPage;"function"==typeof a&&a(e)}catch(e){throw e}}(t)}catch(e){throw e}}}export{q as default};
